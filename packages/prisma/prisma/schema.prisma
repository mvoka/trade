// Trades Dispatch Platform - Prisma Schema
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SMB_USER
  PRO_USER
  ADMIN
  OPERATOR
}

enum VerificationStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
}

enum JobStatus {
  DRAFT
  DISPATCHED
  ACCEPTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum DispatchAttemptStatus {
  PENDING
  ACCEPTED
  DECLINED
  TIMEOUT
  CANCELLED
}

enum BookingMode {
  EXACT
  WINDOW
}

enum BookingStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum ConsentType {
  TRANSACTIONAL_SMS
  MARKETING_SMS
  TRANSACTIONAL_EMAIL
  MARKETING_EMAIL
  CALL_RECORDING
}

enum ScopeType {
  GLOBAL
  REGION
  ORG
  SERVICE_CATEGORY
}

enum MessageSender {
  SMB
  PRO
  OPERATOR
  SYSTEM
}

enum NotificationChannel {
  SMS
  EMAIL
  PUSH
  IN_APP
}

enum AttachmentType {
  BEFORE_PHOTO
  AFTER_PHOTO
  DOCUMENT
  OTHER
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum LeadSource {
  WEB_FORM
  WEBHOOK
  EMAIL
  PHONE
  MANUAL
}

enum LeadStatus {
  RAW
  NORMALIZED
  CONVERTED
  DUPLICATE
  INVALID
}

enum AgentMode {
  INBOUND_ONLY
  INBOUND_OUTBOUND
}

enum PortfolioVisibility {
  PRIVATE
  PUBLIC
}

enum BoostStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// ============================================
// PHASE 3 ENUMS
// ============================================

enum UserType {
  CONSUMER
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  PAST_DUE
  TRIAL
}

enum BillingInterval {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
  ONE_TIME
}

enum ServiceOccurrenceStatus {
  SCHEDULED
  JOB_CREATED
  COMPLETED
  SKIPPED
  CANCELLED
}

enum OfferStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
  ARCHIVED
}

enum AgentAutomationMode {
  MANUAL
  ASSIST
  AUTO
}

enum BranchType {
  HEADQUARTERS
  BRANCH
  FRANCHISE
}

// ============================================
// IDENTITY & RBAC
// ============================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  firstName         String?
  lastName          String?
  phone             String?
  role              UserRole  @default(SMB_USER)
  userType          UserType  @default(BUSINESS)
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  passwordResetToken String?
  passwordResetExpiry DateTime?
  lastLoginAt       DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  proProfile        ProProfile?
  consumerProfile   ConsumerProfile?
  orgMemberships    OrgMember[]
  jobs              Job[]           @relation("JobCreator")
  consents          Consent[]
  agentSessions     AgentSession[]
  auditLogs         AuditLog[]      @relation("AuditActor")
  refreshTokens     RefreshToken[]
  preferredContractorsAsSMB PreferredContractor[] @relation("SMBPreferred")
  sentMessages      Message[]       @relation("MessageSender")
  notifications     NotificationLog[]

  @@index([email])
  @@index([role])
  @@index([userType])
}

model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  revokedAt   DateTime?

  @@index([userId])
  @@index([token])
}

// ============================================
// ORGANIZATIONS & PROS
// ============================================

model Region {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  featureFlags  FeatureFlag[]
  policies      Policy[]
  proProfiles   ProProfile[]

  @@index([code])
}

model ServiceCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  featureFlags      FeatureFlag[]
  policies          Policy[]
  proProfiles       ProProfile[]  @relation("ProServiceCategories")
  jobs              Job[]
  verificationChecklists VerificationChecklist[]
  offerCampaigns    OfferCampaign[]

  @@index([code])
}

model Org {
  id            String   @id @default(cuid())
  name          String
  legalName     String?
  taxId         String?
  phone         String?
  email         String?
  website       String?
  addressLine1  String?
  addressLine2  String?
  city          String?
  province      String?
  postalCode    String?
  country       String   @default("CA")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  members          OrgMember[]
  featureFlags     FeatureFlag[]
  policies         Policy[]
  proProfiles      ProProfile[]
  branches         OrgBranch[]
  automationConfig AgentAutomationConfig?

  @@index([name])
}

model OrgMember {
  id        String   @id @default(cuid())
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member") // owner, admin, member
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
}

model ProProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orgId               String?
  org                 Org?     @relation(fields: [orgId], references: [id])
  regionId            String?
  region              Region?  @relation(fields: [regionId], references: [id])

  // Business Info
  businessName        String?
  businessPhone       String?
  businessEmail       String?
  bio                 String?
  yearsExperience     Int?
  avatarUrl           String?
  verificationBadge   String?  // Badge type earned (e.g., "VERIFIED", "TOP_PRO", "ELITE")

  // Verification
  verificationStatus  VerificationStatus @default(PENDING)
  verifiedAt          DateTime?

  // Metrics (for ranking)
  avgResponseMinutes  Float?
  completionRate      Float?
  totalJobsCompleted  Int      @default(0)

  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  serviceCategories   ServiceCategory[] @relation("ProServiceCategories")
  serviceArea         ServiceArea?
  serviceHours        ServiceHours[]
  verificationRecords VerificationRecord[]
  dispatchAttempts    DispatchAttempt[]
  dispatchAssignments DispatchAssignment[]
  availabilityRules   AvailabilityRule[]
  bookings            Booking[]
  preferredByContractors PreferredContractor[] @relation("ProPreferred")
  portfolioItems      PortfolioItem[]
  portfolio           ProPortfolio?
  servicePlans        ServicePlan[]
  reviews             Review[]

  @@index([userId])
  @@index([orgId])
  @@index([verificationStatus])
}

model ServiceArea {
  id          String   @id @default(cuid())
  proProfileId String  @unique
  proProfile  ProProfile @relation(fields: [proProfileId], references: [id], onDelete: Cascade)
  centerLat   Float
  centerLng   Float
  radiusKm    Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([centerLat, centerLng])
}

model ServiceHours {
  id           String    @id @default(cuid())
  proProfileId String
  proProfile   ProProfile @relation(fields: [proProfileId], references: [id], onDelete: Cascade)
  dayOfWeek    DayOfWeek
  startTime    String    // HH:mm format
  endTime      String    // HH:mm format
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([proProfileId, dayOfWeek])
  @@index([proProfileId])
}

// ============================================
// VERIFICATION & COMPLIANCE
// ============================================

model VerificationChecklist {
  id                String   @id @default(cuid())
  serviceCategoryId String
  serviceCategory   ServiceCategory @relation(fields: [serviceCategoryId], references: [id], onDelete: Cascade)
  documentType      String   // e.g., "LICENSE", "INSURANCE", "WSIB"
  name              String
  description       String?
  isRequired        Boolean  @default(true)
  expiryRequired    Boolean  @default(false)
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([serviceCategoryId, documentType])
  @@index([serviceCategoryId])
}

model VerificationRecord {
  id             String             @id @default(cuid())
  proProfileId   String
  proProfile     ProProfile         @relation(fields: [proProfileId], references: [id], onDelete: Cascade)
  status         VerificationStatus @default(PENDING)
  reviewedById   String?
  reviewedAt     DateTime?
  reviewNotes    String?
  submittedAt    DateTime           @default(now())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  documents      VerificationDocument[]

  @@index([proProfileId])
  @@index([status])
}

model VerificationDocument {
  id                   String             @id @default(cuid())
  verificationRecordId String
  verificationRecord   VerificationRecord @relation(fields: [verificationRecordId], references: [id], onDelete: Cascade)
  documentType         String             // LICENSE, INSURANCE, WSIB, etc.
  fileName             String
  fileUrl              String
  fileSize             Int?
  mimeType             String?
  expiryDate           DateTime?
  status               VerificationStatus @default(PENDING)
  reviewNotes          String?
  uploadedAt           DateTime           @default(now())
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([verificationRecordId])
  @@index([documentType])
}

// ============================================
// FEATURE FLAGS & POLICIES
// ============================================

model FeatureFlag {
  id                String    @id @default(cuid())
  key               String
  description       String?
  enabled           Boolean   @default(false)
  scopeType         ScopeType @default(GLOBAL)
  regionId          String?
  region            Region?   @relation(fields: [regionId], references: [id], onDelete: Cascade)
  orgId             String?
  org               Org?      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  serviceCategoryId String?
  serviceCategory   ServiceCategory? @relation(fields: [serviceCategoryId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdById       String?

  @@unique([key, scopeType, regionId, orgId, serviceCategoryId])
  @@index([key])
  @@index([scopeType])
}

model Policy {
  id                String    @id @default(cuid())
  key               String
  description       String?
  value             Json      // JSON value for flexible configuration
  scopeType         ScopeType @default(GLOBAL)
  regionId          String?
  region            Region?   @relation(fields: [regionId], references: [id], onDelete: Cascade)
  orgId             String?
  org               Org?      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  serviceCategoryId String?
  serviceCategory   ServiceCategory? @relation(fields: [serviceCategoryId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdById       String?

  @@unique([key, scopeType, regionId, orgId, serviceCategoryId])
  @@index([key])
  @@index([scopeType])
}

// ============================================
// CONSENT
// ============================================

model Consent {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        ConsentType
  granted     Boolean     @default(false)
  grantedAt   DateTime?
  revokedAt   DateTime?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([userId, type])
  @@index([userId])
}

// ============================================
// LEAD INTAKE
// ============================================

model LeadRaw {
  id          String     @id @default(cuid())
  source      LeadSource
  rawPayload  Json
  ipAddress   String?
  userAgent   String?
  receivedAt  DateTime   @default(now())
  processedAt DateTime?
  createdAt   DateTime   @default(now())

  // Relations
  normalizedLead LeadNormalized?

  @@index([source])
  @@index([receivedAt])
}

model LeadNormalized {
  id                String     @id @default(cuid())
  leadRawId         String?    @unique
  leadRaw           LeadRaw?   @relation(fields: [leadRawId], references: [id])
  status            LeadStatus @default(NORMALIZED)

  // Parsed fields
  contactName       String?
  contactEmail      String?
  contactPhone      String?
  businessName      String?
  serviceAddress    String?
  serviceLat        Float?
  serviceLng        Float?
  serviceCategory   String?
  description       String?
  preferredDateStart DateTime?
  preferredDateEnd  DateTime?
  urgency           String?    // LOW, NORMAL, HIGH, EMERGENCY

  // Deduplication
  fingerprint       String?    // Hash for duplicate detection
  duplicateOfId     String?

  // Conversion
  convertedToJobId  String?    @unique
  convertedToJob    Job?       @relation(fields: [convertedToJobId], references: [id])
  convertedAt       DateTime?

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([status])
  @@index([fingerprint])
  @@index([contactEmail])
}

// ============================================
// JOBS & CRM
// ============================================

model Job {
  id                  String    @id @default(cuid())
  jobNumber           String    @unique @default(cuid())
  createdById         String
  createdBy           User      @relation("JobCreator", fields: [createdById], references: [id])
  serviceCategoryId   String
  serviceCategory     ServiceCategory @relation(fields: [serviceCategoryId], references: [id])
  status              JobStatus @default(DRAFT)

  // Contact Info
  contactName         String
  contactEmail        String?
  contactPhone        String
  businessName        String?

  // Service Location
  serviceAddressLine1 String
  serviceAddressLine2 String?
  serviceCity         String
  serviceProvince     String
  servicePostalCode   String
  serviceCountry      String    @default("CA")
  serviceLat          Float?
  serviceLng          Float?

  // Job Details
  title               String?
  description         String
  preferredDateStart  DateTime?
  preferredDateEnd    DateTime?
  urgency             String    @default("NORMAL")
  estimatedDuration   Int?      // minutes

  // Assignment
  assignedProId       String?

  // Timestamps
  dispatchedAt        DateTime?
  acceptedAt          DateTime?
  scheduledAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  cancelledAt         DateTime?

  // Metadata
  internalNotes       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  fromLead              LeadNormalized?
  attachments           JobAttachment[]
  dispatchAttempts      DispatchAttempt[]
  dispatchAssignment    DispatchAssignment?
  bookings              Booking[]
  messageThread         MessageThread?
  pipelineStage         PipelineStage?  @relation(fields: [pipelineStageId], references: [id])
  pipelineStageId       String?
  tasks                 Task[]
  reminders             Reminder[]
  portfolioItems        PortfolioItem[]
  reviews               Review[]
  subscriptionOccurrence ServiceOccurrence? @relation("OccurrenceJob")

  @@index([createdById])
  @@index([serviceCategoryId])
  @@index([status])
  @@index([jobNumber])
}

model JobAttachment {
  id          String         @id @default(cuid())
  jobId       String
  job         Job            @relation(fields: [jobId], references: [id], onDelete: Cascade)
  type        AttachmentType
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  uploadedById String?
  uploadedAt  DateTime       @default(now())
  createdAt   DateTime       @default(now())

  @@index([jobId])
  @@index([type])
}

model PipelineStage {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String?
  sortOrder   Int      @default(0)
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  jobs        Job[]

  @@index([sortOrder])
}

model Task {
  id          String    @id @default(cuid())
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean   @default(false)
  completedAt DateTime?
  assignedTo  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([jobId])
  @@index([dueDate])
}

model Reminder {
  id          String   @id @default(cuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  title       String
  message     String?
  remindAt    DateTime
  sent        Boolean  @default(false)
  sentAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([jobId])
  @@index([remindAt])
}

model JobTemplate {
  id              String   @id @default(cuid())
  name            String
  description     String?
  categoryCode    String?  // Service category code
  templateContent Json     // Template fields/structure
  estimatedDuration Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([categoryCode])
}

// ============================================
// DISPATCH ENGINE
// ============================================

model DeclineReason {
  id          String   @id @default(cuid())
  code        String   @unique
  label       String
  description String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  dispatchAttempts DispatchAttempt[]

  @@index([code])
}

model DispatchAttempt {
  id              String                @id @default(cuid())
  jobId           String
  job             Job                   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  proProfileId    String
  proProfile      ProProfile            @relation(fields: [proProfileId], references: [id])
  attemptNumber   Int
  status          DispatchAttemptStatus @default(PENDING)
  declineReasonId String?
  declineReason   DeclineReason?        @relation(fields: [declineReasonId], references: [id])
  declineNotes    String?
  dispatchedAt    DateTime              @default(now())
  respondedAt     DateTime?
  slaDeadline     DateTime
  ranking         Float?                // Score used for this attempt
  distance        Float?                // Distance in km
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@unique([jobId, proProfileId])
  @@index([jobId])
  @@index([proProfileId])
  @@index([status])
}

model DispatchAssignment {
  id           String     @id @default(cuid())
  jobId        String     @unique
  job          Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  proProfileId String
  proProfile   ProProfile @relation(fields: [proProfileId], references: [id])
  assignedAt   DateTime   @default(now())
  assignedBy   String?    // User ID if manual assignment
  isManual     Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([proProfileId])
}

// ============================================
// BOOKING ENGINE
// ============================================

model AvailabilityRule {
  id           String    @id @default(cuid())
  proProfileId String
  proProfile   ProProfile @relation(fields: [proProfileId], references: [id], onDelete: Cascade)
  dayOfWeek    DayOfWeek
  slots        Json      // Array of {startTime, endTime} objects
  exceptions   Json?     // Specific dates with overrides
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([proProfileId, dayOfWeek])
  @@index([proProfileId])
}

model BookingPolicy {
  id                String    @id @default(cuid())
  scopeType         ScopeType @default(GLOBAL)
  regionId          String?
  orgId             String?
  serviceCategoryId String?

  // Policy values
  leadTimeMinutes   Int       @default(60)      // Minimum advance booking time
  bufferMinutes     Int       @default(15)      // Buffer between bookings
  maxPerDay         Int       @default(10)      // Max bookings per day
  cancellationHours Int       @default(24)      // Hours before for free cancellation

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([scopeType])
}

model Booking {
  id           String        @id @default(cuid())
  jobId        String
  job          Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  proProfileId String
  proProfile   ProProfile    @relation(fields: [proProfileId], references: [id])
  mode         BookingMode
  status       BookingStatus @default(PENDING_CONFIRMATION)

  // For EXACT mode
  slotStart    DateTime?
  slotEnd      DateTime?

  // For WINDOW mode
  windowStart  DateTime?
  windowEnd    DateTime?
  confirmedStart DateTime?
  confirmedEnd DateTime?

  confirmedAt  DateTime?
  cancelledAt  DateTime?
  cancelReason String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([jobId])
  @@index([proProfileId])
  @@index([status])
}

model CalendarConnection {
  id           String   @id @default(cuid())
  proProfileId String
  provider     String   // GOOGLE, OUTLOOK, etc.
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  calendarId   String?
  isActive     Boolean  @default(true)
  lastSyncAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([proProfileId])
}

// ============================================
// PREFERRED CONTRACTORS & BOOST
// ============================================

model PreferredContractor {
  id           String     @id @default(cuid())
  smbUserId    String
  smbUser      User       @relation("SMBPreferred", fields: [smbUserId], references: [id], onDelete: Cascade)
  proProfileId String
  proProfile   ProProfile @relation("ProPreferred", fields: [proProfileId], references: [id], onDelete: Cascade)
  notes        String?
  createdAt    DateTime   @default(now())

  @@unique([smbUserId, proProfileId])
  @@index([smbUserId])
  @@index([proProfileId])
}

model BoostCampaign {
  id           String      @id @default(cuid())
  proProfileId String
  name         String
  budgetCents  Int
  spentCents   Int         @default(0)
  status       BoostStatus @default(ACTIVE)
  startDate    DateTime
  endDate      DateTime?
  targeting    Json?       // Targeting criteria
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  ledgerEntries BoostLedger[]

  @@index([proProfileId])
  @@index([status])
}

model BoostLedger {
  id         String        @id @default(cuid())
  campaignId String
  campaign   BoostCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  amountCents Int
  type       String        // CHARGE, REFUND, ADJUSTMENT
  description String?
  createdAt  DateTime      @default(now())

  @@index([campaignId])
}

// ============================================
// COMMUNICATIONS HUB
// ============================================

model MessageThread {
  id        String    @id @default(cuid())
  jobId     String    @unique
  job       Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  messages  Message[]

  @@index([jobId])
}

model Message {
  id            String        @id @default(cuid())
  threadId      String
  thread        MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderId      String?
  sender        User?         @relation("MessageSender", fields: [senderId], references: [id])
  senderType    MessageSender
  content       String
  attachmentUrl String?
  readAt        DateTime?
  createdAt     DateTime      @default(now())

  @@index([threadId])
  @@index([senderId])
}

model NotificationLog {
  id          String              @id @default(cuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel     NotificationChannel
  type        String              // notification type/template
  subject     String?
  content     String
  metadata    Json?
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  failReason  String?
  createdAt   DateTime            @default(now())

  @@index([userId])
  @@index([channel])
  @@index([createdAt])
}

// ============================================
// DOCUMENTS & PORTFOLIO
// ============================================

model PortfolioItem {
  id           String              @id @default(cuid())
  proProfileId String
  proProfile   ProProfile          @relation(fields: [proProfileId], references: [id], onDelete: Cascade)
  jobId        String?
  job          Job?                @relation(fields: [jobId], references: [id])
  title        String?
  description  String?
  mediaUrl     String
  mediaType    String?             // image, video
  visibility   PortfolioVisibility @default(PRIVATE)
  optInGranted Boolean             @default(false)
  optInAt      DateTime?
  sortOrder    Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([proProfileId])
  @@index([visibility])
}

// ============================================
// AI AGENT ORCHESTRATOR
// ============================================

model AgentSession {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  sessionType   String   // VOICE, CHAT, etc.
  mode          AgentMode @default(INBOUND_ONLY)
  startedAt     DateTime @default(now())
  endedAt       DateTime?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  callLogs      CallLog[]
  conversationTurns ConversationTurn[]
  toolCallLogs  ToolCallLog[]

  @@index([userId])
  @@index([sessionType])
}

model CallLog {
  id             String       @id @default(cuid())
  agentSessionId String
  agentSession   AgentSession @relation(fields: [agentSessionId], references: [id], onDelete: Cascade)
  direction      String       // INBOUND, OUTBOUND
  fromNumber     String?
  toNumber       String?
  startedAt      DateTime
  endedAt        DateTime?
  duration       Int?         // seconds
  recordingUrl   String?
  transcriptUrl  String?
  consentGiven   Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([agentSessionId])
}

model ConversationTurn {
  id             String       @id @default(cuid())
  agentSessionId String
  agentSession   AgentSession @relation(fields: [agentSessionId], references: [id], onDelete: Cascade)
  role           String       // USER, ASSISTANT, SYSTEM
  content        String
  contentSanitized String?    // PII redacted version
  turnNumber     Int
  createdAt      DateTime     @default(now())

  @@index([agentSessionId])
}

model ToolCallLog {
  id             String       @id @default(cuid())
  agentSessionId String
  agentSession   AgentSession @relation(fields: [agentSessionId], references: [id], onDelete: Cascade)
  toolName       String
  inputParams    Json
  outputResult   Json?
  status         String       // SUCCESS, FAILED, DENIED
  durationMs     Int?
  errorMessage   String?
  createdAt      DateTime     @default(now())

  // Relations
  actionResults  ActionResult[]

  @@index([agentSessionId])
  @@index([toolName])
}

model ActionResult {
  id            String      @id @default(cuid())
  toolCallLogId String
  toolCallLog   ToolCallLog @relation(fields: [toolCallLogId], references: [id], onDelete: Cascade)
  actionType    String
  entityType    String?
  entityId      String?
  success       Boolean
  message       String?
  createdAt     DateTime    @default(now())

  @@index([toolCallLogId])
}

// ============================================
// AUDIT LOGGING
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // e.g., PRO_APPROVED, JOB_CREATED, DISPATCH_ACCEPTED
  actorId     String?
  actor       User?    @relation("AuditActor", fields: [actorId], references: [id])
  actorType   String?  // USER, SYSTEM, AGENT
  targetType  String?  // Entity type affected
  targetId    String?  // Entity ID affected
  details     Json?    // Additional context (PII masked)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([actorId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ============================================
// PAYMENT ABSTRACTIONS
// ============================================

model PaymentAccount {
  id             String   @id @default(cuid())
  proProfileId   String
  provider       String   // STRIPE, etc.
  externalId     String   // Stripe account ID
  status         String   // PENDING, ACTIVE, DISABLED
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([proProfileId])
}

model PaymentTransaction {
  id             String   @id @default(cuid())
  jobId          String?
  externalId     String?  // Stripe payment intent ID
  type           String   // PAYMENT, REFUND, ESCROW_HOLD, ESCROW_RELEASE
  amountCents    Int
  currency       String   @default("CAD")
  status         String   // PENDING, COMPLETED, FAILED
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([jobId])
  @@index([externalId])
}

// ============================================
// PHASE 3: CONSUMER / HOMEOWNER PROFILES
// ============================================

model ConsumerProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Property Info
  propertyType        String?  // HOUSE, CONDO, TOWNHOUSE, etc.
  propertyAddressLine1 String?
  propertyAddressLine2 String?
  propertyCity        String?
  propertyProvince    String?
  propertyPostalCode  String?
  propertyCountry     String   @default("CA")
  propertyLat         Float?
  propertyLng         Float?

  // Marketing
  marketingOptIn      Boolean  @default(false)
  marketingOptInAt    DateTime?

  // Metadata
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  subscriptions       Subscription[]
  offerLeads          OfferLead[]

  @@index([userId])
}

// ============================================
// PHASE 3: SUBSCRIPTION SERVICE PLANS
// ============================================

model ServicePlan {
  id                    String          @id @default(cuid())
  proProfileId          String?
  proProfile            ProProfile?     @relation(fields: [proProfileId], references: [id])
  serviceCategoryId     String?

  // Plan Details
  name                  String
  description           String?
  billingInterval       BillingInterval
  pricePerIntervalCents Int
  currency              String          @default("CAD")

  // Service Template
  serviceTemplate       Json            // Template for job creation
  visitsPerInterval     Int             @default(1)
  estimatedDurationMins Int?

  // Status
  isActive              Boolean         @default(true)
  isPublic              Boolean         @default(true)  // Visible to consumers
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  subscriptions         Subscription[]

  @@index([proProfileId])
  @@index([serviceCategoryId])
  @@index([billingInterval])
}

model Subscription {
  id                    String             @id @default(cuid())
  consumerProfileId     String
  consumerProfile       ConsumerProfile    @relation(fields: [consumerProfileId], references: [id], onDelete: Cascade)
  servicePlanId         String
  servicePlan           ServicePlan        @relation(fields: [servicePlanId], references: [id])

  // Status
  status                SubscriptionStatus @default(TRIAL)
  startDate             DateTime           @default(now())
  endDate               DateTime?
  pausedAt              DateTime?
  cancelledAt           DateTime?
  cancelReason          String?

  // Billing
  stripeSubscriptionId  String?            @unique
  stripeCustomerId      String?
  nextBillingDate       DateTime?
  lastBillingDate       DateTime?

  // Schedule
  preferredDayOfWeek    DayOfWeek?
  preferredTimeSlot     String?            // HH:mm format

  // Metadata
  metadata              Json?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  // Relations
  occurrences           ServiceOccurrence[]

  @@index([consumerProfileId])
  @@index([servicePlanId])
  @@index([status])
  @@index([stripeSubscriptionId])
}

model ServiceOccurrence {
  id                String                  @id @default(cuid())
  subscriptionId    String
  subscription      Subscription            @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Schedule
  scheduledDate     DateTime
  scheduledTimeSlot String?                 // HH:mm format
  occurrenceNumber  Int                     // 1, 2, 3, etc. in sequence

  // Status
  status            ServiceOccurrenceStatus @default(SCHEDULED)

  // Job Link (when created)
  jobId             String?                 @unique
  job               Job?                    @relation("OccurrenceJob", fields: [jobId], references: [id])
  jobCreatedAt      DateTime?

  // Completion
  completedAt       DateTime?
  skipReason        String?

  // Metadata
  notes             String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  @@index([subscriptionId])
  @@index([scheduledDate])
  @@index([status])
}

// ============================================
// PHASE 3: PRO PORTFOLIO
// ============================================

model ProPortfolio {
  id            String     @id @default(cuid())
  proProfileId  String     @unique
  proProfile    ProProfile @relation(fields: [proProfileId], references: [id], onDelete: Cascade)

  // Public Page
  slug          String     @unique
  headline      String?
  bio           String?
  description   String?
  theme         String     @default("default")  // Portfolio theme
  coverImageUrl String?
  logoUrl       String?

  // SEO
  metaTitle     String?
  metaDescription String?

  // Contact Settings
  showPhone     Boolean    @default(false)
  showEmail     Boolean    @default(false)
  displayEmail  String?    // Actual email to show publicly
  displayPhone  String?    // Actual phone to show publicly
  contactFormEnabled Boolean @default(true)

  // Display Options
  showReviews   Boolean    @default(true)
  socialLinks   Json?      // { twitter: "...", linkedin: "..." }

  // Status
  isPublished   Boolean    @default(false)
  publishedAt   DateTime?

  // Stats
  viewCount     Int        @default(0)
  inquiryCount  Int        @default(0)

  // Relations
  reviews       Review[]

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([slug])
  @@index([isPublished])
}

model Review {
  id            String       @id @default(cuid())
  proProfileId  String
  proProfile    ProProfile   @relation(fields: [proProfileId], references: [id], onDelete: Cascade)
  portfolioId   String?
  portfolio     ProPortfolio? @relation(fields: [portfolioId], references: [id])
  jobId         String?
  job           Job?         @relation(fields: [jobId], references: [id])

  // Review Content
  rating        Int          // 1-5
  comment       String?
  reviewerName  String?

  // Visibility
  isPublic      Boolean      @default(true)
  isVerified    Boolean      @default(false)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([proProfileId])
  @@index([portfolioId])
  @@index([isPublic])
}

// ============================================
// PHASE 3: OFFER CAMPAIGNS & LEAD GEN
// ============================================

model OfferCampaign {
  id                      String           @id @default(cuid())
  proProfileId            String?          // Optional: can be platform-wide
  regionId                String?
  serviceCategoryId       String?
  serviceCategory         ServiceCategory? @relation(fields: [serviceCategoryId], references: [id])

  // Campaign Details
  slug                    String      @unique
  headline                String
  subheadline             String?
  description             String?
  offerType               String      // DISCOUNT, FREE_ESTIMATE, FIRST_TIME, SEASONAL
  offerValue              String?     // e.g., "15% OFF", "$50 credit"
  discountValue           Float?      // Numeric discount value

  // Landing Page
  heroImageUrl            String?
  ctaText                 String      @default("Get Started")
  thankYouMessage         String?

  // Compliance
  requiresMarketingConsent Boolean    @default(true)
  termsText               String?
  privacyPolicyUrl        String?

  // Status & Scheduling
  status                  OfferStatus @default(DRAFT)
  startDate               DateTime?
  endDate                 DateTime?
  expiresAt               DateTime?   // Explicit expiration
  maxLeads                Int?        // Optional cap

  // Custom Fields
  customFields            Json?       // Custom form field definitions

  // Tracking
  viewCount               Int         @default(0)
  leadCount               Int         @default(0)
  conversionRate          Float?

  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  // Relations
  leads                   OfferLead[]

  @@index([slug])
  @@index([status])
  @@index([proProfileId])
  @@index([serviceCategoryId])
}

model OfferLead {
  id                      String          @id @default(cuid())
  campaignId              String
  campaign                OfferCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  consumerProfileId       String?
  consumerProfile         ConsumerProfile? @relation(fields: [consumerProfileId], references: [id])

  // Contact Info
  name                    String?         // Display name (alternative to firstName/lastName)
  firstName               String?
  lastName                String?
  email                   String
  phone                   String?
  address                 String?         // Short address for display

  // Property (if provided)
  propertyAddress         String?
  propertyType            String?

  // Request Details
  serviceInterest         String?
  message                 String?
  notes                   String?         // Internal notes from agents/admins
  preferredContactMethod  String?         // EMAIL, PHONE, SMS

  // Custom Fields
  customFieldValues       Json?           // Responses to campaign custom fields

  // Consent & Compliance
  marketingConsentGranted Boolean         @default(false)
  marketingConsentAt      DateTime?
  ipAddress               String?
  userAgent               String?

  // Follow-up
  followUpCount           Int             @default(0)
  lastFollowUpAt          DateTime?
  lastContactedAt         DateTime?       // Last outreach attempt
  nextFollowUpAt          DateTime?
  status                  String          @default("NEW")  // NEW, CONTACTED, QUALIFIED, CONVERTED, CLOSED

  // Conversion
  convertedToJobId        String?
  convertedAt             DateTime?

  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  @@index([campaignId])
  @@index([email])
  @@index([status])
  @@index([consumerProfileId])
}

// ============================================
// PHASE 3: MULTI-BRANCH SUPPORT
// ============================================

model OrgBranch {
  id            String     @id @default(cuid())
  orgId         String
  org           Org        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  parentBranchId String?
  parentBranch  OrgBranch? @relation("BranchHierarchy", fields: [parentBranchId], references: [id])

  // Branch Details
  name          String
  code          String?    // Internal branch code
  branchType    BranchType @default(BRANCH)

  // Location
  addressLine1  String?
  addressLine2  String?
  city          String?
  province      String?
  postalCode    String?
  country       String     @default("CA")
  lat           Float?
  lng           Float?

  // Region Assignment
  regionId      String?

  // Contact
  phone         String?
  email         String?
  managerName   String?

  // Service Area
  serviceRadiusKm Float?

  // Status
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  childBranches OrgBranch[] @relation("BranchHierarchy")

  @@unique([orgId, code])
  @@index([orgId])
  @@index([branchType])
  @@index([regionId])
}

// ============================================
// PHASE 3: AGENT AUTOMATION CONFIG
// ============================================

model AgentAutomationConfig {
  id                    String              @id @default(cuid())
  orgId                 String              @unique
  org                   Org                 @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Automation Modes
  schedulingMode        AgentAutomationMode @default(MANUAL)
  intakeMode            AgentAutomationMode @default(MANUAL)
  dispatchMode          AgentAutomationMode @default(MANUAL)
  communicationMode     AgentAutomationMode @default(MANUAL)
  portfolioMode         AgentAutomationMode @default(MANUAL)
  outreachMode          AgentAutomationMode @default(MANUAL)

  // Guardrails
  maxActionsPerHour     Int                 @default(10)
  approvalThresholdCents Int                @default(10000)  // $100 default
  requireApprovalForPayments Boolean        @default(true)
  requireApprovalForOutbound Boolean        @default(true)

  // Notification Settings
  notifyOnAutoAction    Boolean             @default(true)
  notifyEmail           String?
  notifyPhone           String?

  // Audit
  lastAutoActionAt      DateTime?
  totalAutoActions      Int                 @default(0)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([orgId])
}
